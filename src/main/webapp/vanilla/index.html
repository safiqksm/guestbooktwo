<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>vanilla (testpage for rest)</title>
    </head>
    <body>
        <h1>vanilla (testpage for rest)</h1>
        <ul>
            <li><a href="../rest/helloworld?_wadl">link to wadl if you're using cxf (on tomee)</a></li>
            <li><a href="../rest/application.wadl">link to wadl if you're using jersey (on glassfish)</a></li>
            <li><a href="../rest/helloworld">../rest/helloworld with Accept: text/html</a></li>
            <li><button id="xml">../rest/helloworld with Accept: application/xml</button></li>
            <li><button id="json">../rest/helloworld with Accept: application/json</button></li>
            <li><button id="xmllist">../rest/helloworld/list with Accept: application/xml</button></li>
            <li><button id="jsonlist">../rest/helloworld/list with Accept: application/json</button></li>
            <li><button id="xmlcomplicated">../rest/helloworld/complicated with Accept: application/xml</button></li>
            <li><button id="jsoncomplicated"><b>../rest/helloworld/complicated with Accept: application/json</b></button></li>
            <li><button id="jsonecho">../rest/helloworld/echo with Accept: application/json</button></li>

            <li><button id="xmljquery">../rest/helloworld with Accept: application/xml (uses jQuery)</button></li>
            <li><button id="jsonjquery">../rest/helloworld with Accept: application/json (uses jQuery)</button></li>
            <li><button id="xmllistjquery">../rest/helloworld/list with Accept: application/xml (uses jQuery)</button></li>
            <li><button id="jsonlistjquery">../rest/helloworld/list with Accept: application/json (uses jQuery)</button></li>
            <li><button id="jsonechojquery">../rest/helloworld/echo with Accept: application/json (uses jQuery)</button></li>
        </ul>
        <pre id="output"></pre>
        <p>I've had quite a few problems with Supporting unwrapped JSON. Here are some links with more info about that:</p>
        <ul>
            <li><a href="http://www.jroller.com/gmazza/entry/jersey_samples_on_cxf#jc13">Parsing differences between XML, Jettison and Jackson JSON processors</a></li>
            <li><a href="https://github.com/gmazza/jersey-samples-on-cxf/blob/master/json-from-jaxb/src/main/java/com/sun/jersey/samples/jsonfromjaxb/jaxb/MessageBean.java">MessageBean.java source</a><br/>
                Contains comment explaining the problem with wrapped json.</li>
            <li><a href="http://rmannibucau.wordpress.com/2012/10/04/jax-rsjax-ws-configuration-for-tomee-1-5-0/">JAX-RS/JAX-WS configuration for TomEE 1.5.0</a><br/>
                Explains the placement of openejb-jar.xml to configure JAX-RS endpoints.</li>
            <li><a href="https://gist.github.com/rmannibucau/a4371909c0bc07e2383d">gist by rmannibucau explaining the use of JacksonJsonProvider</a><br/>
                <pre>
diff --git a/pom.xml b/pom.xml
index afcef59..d0d565d 100644
--- a/pom.xml
+++ b/pom.xml
@@ -36,5 +36,11 @@
       &lt;version&gt;6.0-4&lt;/version&gt;
       &lt;scope&gt;provided&lt;/scope&gt;
     &lt;/dependency&gt;
+    &lt;dependency&gt;
+      &lt;groupId&gt;com.fasterxml.jackson.jaxrs&lt;/groupId&gt;
+      &lt;artifactId&gt;jackson-jaxrs-json-provider&lt;/artifactId&gt;
+      &lt;version&gt;2.1.4&lt;/version&gt;
+    &lt;/dependency&gt;
+
   &lt;/dependencies&gt;
 &lt;/project&gt;
\ No newline at end of file
diff --git a/src/main/webapp/WEB-INF/resources.xml b/src/main/webapp/WEB-INF/resources.xml
index 159e0e9..67514b2 100644
--- a/src/main/webapp/WEB-INF/resources.xml
+++ b/src/main/webapp/WEB-INF/resources.xml
@@ -1,9 +1,4 @@
 &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
 &lt;resources&gt;
-  &lt;Service id=&quot;json&quot; class-name=&quot;org.apache.cxf.jaxrs.provider.json.JSONProvider&quot;&gt;
-    SkipJaxbChecks = true
-    DropRootElement = true
-    SupportUnwrapped = true
-    SingleJaxbContext = true
-  &lt;/Service&gt;
+  &lt;Service id=&quot;json&quot; class-name=&quot;com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider&quot; /&gt;
 &lt;/resources&gt;
                </pre>
            </li>
            <li><a href="http://openejb.979440.n4.nabble.com/Configuring-Apache-CXF-in-TomEE-td4660207.html">Configuring Apache CXF in TomEE</a><br/>
                Explains where to put openejb-jar.xml and resources.xml.</li>
            <li><a href="https://github.com/kouphax/todomvc-server/tree/master/examples/jee6-tomee">todomvc-server jee6-tomee</a><br/>
                This project uses the JacksonJsonProvider. Explains the &quot;Supporting unwrapped JSON&quot; problem in readme.</li>
        </ul>
        <p>In the end this is what I did:</p>
        <pre>TODO</pre>

        <script src="jquery-1.9.1.js"></script>
        <script src="json3.js"></script>
        <script src="vanilla.js"></script>
        <script>
            function log(message) {
                if (message !== null && typeof message === 'string'){
                    if (message.charAt(0) === '+') {
                        message = '<font color="#00cc00">' + message + '<\/font>';
                    } else if (message.charAt(0) === '-') {
                        message = '<font color="#cc0000">' + message + '<\/font>';
                    }
                }
                document.getElementById('output').innerHTML += message + '\n';
            }

            function xmlRequestCallback(response) {
                // alternative
                //var who = response
                //        .getElementsByTagName('greeting')[0]
                //        .getElementsByTagName('who')[0]
                //        .firstChild
                //        .nodeValue;
                // with jQuery
                //var who = jQuery(response, 'greeting > who').text());
                var who = vanilla.evaluateXPath(
                        '/greeting/who/text()', response)[0].nodeValue;
                log('recieved ' + who);
            }
            function xmllistRequestCallback(response) {
                var names = vanilla.evaluateXPath(
                        '/greetings/greeting/who/text()', response);
                log('recieved ' + names[0].nodeValue + ' and ' + names[1].nodeValue);
            }
            function xmlcomplicatedRequestCallback(response) {
                log('recieved TODO');
                //aString should be xsi:nil
                //aDate should be iso?
            }
            function jsonRequestCallback(response) {
                // should be {"who":"JAX-RS"}
                // but we get {"greeting":{"who":"JAX-RS"}}
                // fixed with dropRootElement = true
                if (typeof response.greeting === 'object') {
                    log('- extra root node detected (are you using CXF on TomEE?)');
                    response = response.greeting;
                }
                log('recieved ' + response.who);
            }
            function jsonlistRequestCallback(response) {
                // should be [{"who":"JAX-RS zero"},{"who":"JAX-RS one"}]
                // but we get {"greeting":[{"who":"JAX-RS zero"},{"who":"JAX-RS one"}]}
                if (typeof response.greeting === 'object') {
                    log('- extra root node detected (are you using CXF on TomEE?)');
                    response = response.greeting;
                }
                log('recieved ' + response[0].who + ' and ' + response[1].who);
            }
            function jsoncomplicatedRequestCallback(response) {
                log('recieved complicated thing');
                if (!response.hasOwnProperty('aString')) {
                    log('- null value isn\'t included in response');
                    // CXF
                    // this was forgotten on @XmlElement annotation
                    // nillable = true
                } else {
                    log('+ null value is included in response');
                    if (response.aString === null) {
                        log('+ null value is represented by null');
                        // probably using JacksonJsonProvider
                    } else {
                        if (response.aString === '') {
                            log('- null value is represented by an empty string');
                            // CXF
                            // one of these was probably set
                            // ignoreNamespaces = true
                            // writeXsiType = false
                        } else if (response.aString === 'null') {
                            log('- null value is represented by string "null"');
                        } else if (typeof response.aString === 'string') {
                            log('- null value is represented by a non-empty string');
                        } else if (typeof response.aString === 'object') {
                            log('- null value is represented by an object');
                            if (response.aString.hasOwnProperty('@xsi.nil')) {
                                log('- null is represented as {"@xsi.nil":"true"}');
                                // CXF
                                // none of these was probably set
                                // ignoreNamespaces = true
                                // writeXsiType = false
                            } else {
                                log('- what is this madness?');
                            }
                        }
                    }
                }
                if (!response.hasOwnProperty('aDate')) {
                    log('- date value isn\'t included in response');
                } else {
                    log('+ date value is included in response');
                    if (typeof response.aDate === 'string') {
                        var rx = /^-?\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.\d+)?(?:[-+]\d\d:\d\d|Z)?$/;
                        if (rx.test(response.aDate)) {
                            // 2013-06-02T16:57:31.511+02:00
                            // default CXF
                            // or Jackson with WRITE_DATES_AS_TIMESTAMPS false
                            log('+ DateTime in ISO format');
                        } else {
                            log('- DateTime in custom string format');
                        }
                    } else if (typeof response.aDate === 'number') {
                        console.log(+new Date());
                        console.log(response.aDate);
                        if (Math.abs((+new Date()) - response.aDate) < 5 * 1000) {
                            // default Jackson
                            log('+ DateTime in epoch miliseconds number format');
                        } else if (Math.abs((+new Date()) / 1000 - (response.aDate)) < 5) {
                            log('- DateTime in epoch seconds number format');
                        } else {
                            log('- DateTime in custom number format');
                            log('expected = ' + (+new Date()));
                            log('actual   = ' + response.aDate);
                        }
                    } else {
                        log('- what is this madness?');
                    }
                }
                if (!response.hasOwnProperty('aLong')) {
                    log('- long value isn\'t included in response');
                } else {
                    log('+ long value is included in response');
                    if (typeof response.aLong === 'number') {
                        if (response.aLong === 9007199254740992) {
                            log('- long is maximum acurate integer in javascript, which is incorrect');
                        } else if (response.aLong === 9223372036854775807) {
                            log('+ long is correct (but not acurate because it can\'t be)');
                            log('expected = 9223372036854775807');
                            log('actual   = ' + 9223372036854775807);
                        } else {
                            log('- long = ' + response.aLong);
                        }
                    } else {
                        log('- what is this madness?');
                    }
                }
                if (!response.hasOwnProperty('aNotherString')) {
                    log('- aNotherString value isn\'t included in response');
                } else {
                    log('+ aNotherString value is included in response');
                    if (response.aNotherString === 'a:\u00E1\u00E2\u00E4\u00E0 c:\u00E7 e:\u00E9\u00EA\u00EB\u00E8 i:\u00ED\u00EE\u00EF\u00EC\u0131 I:\u0130 o:\u00F3\u00F4\u00F6\u00F2 u:\u00FA\u00FB\u00FC\u00F9 euro:\u20AC tree:\u2F4A') {
                        log('+ aNotherString was correctly sent trough');
                    } else {
                        log('- what is this madness?');
                        log('expected = a:\u00E1\u00E2\u00E4\u00E0 c:\u00E7 e:\u00E9\u00EA\u00EB\u00E8 i:\u00ED\u00EE\u00EF\u00EC\u0131 I:\u0130 o:\u00F3\u00F4\u00F6\u00F2 u:\u00FA\u00FB\u00FC\u00F9 euro:\u20AC tree:\u2F4A');
                        log('actual   = ' + response.aNotherString);
                    }
                }
            }
            function xmlButtonClick() {
                vanilla.request('GET', '../rest/helloworld', 'xml', null, xmlRequestCallback);
            }

            function xmllistButtonClick() {
                vanilla.request('GET', '../rest/helloworld/list', 'xml', null, xmllistRequestCallback);
            }
            function xmlcomplicatedButtonClick() {
                vanilla.request('GET', '../rest/helloworld/complicated', 'xml', null, xmlcomplicatedRequestCallback);
            }

            function jsonButtonClick() {
                vanilla.request('GET', '../rest/helloworld', 'json', null, jsonRequestCallback);
            }

            function jsonlistButtonClick() {
                vanilla.request('GET', '../rest/helloworld/list', 'json', null, jsonlistRequestCallback);
            }

            function jsoncomplicatedButtonClick() {
                vanilla.request('GET', '../rest/helloworld/complicated', 'json', null, jsoncomplicatedRequestCallback);
            }

            function jsonechoButtonClick() {
                vanilla.request('POST', '../rest/helloworld/echo', 'json', {
                    "greetings": [
                        {"who": "b"},
                        {"who": "c"}],
                    "aBigDecimal": "9999999999999999999999.1",
                    "aBigInteger": "9999999999999999999999",
                    "aBoolean": true,
                    "aDate": vanilla.dateToISO(new Date()),
                    "aDouble": 0.1,
                    "aFloat": 0.1,
                    "aGreeting": {"who": "a"},
                    "aInteger": 1,
                    //"aLong": 9007199254740992,
                    //"aLong": 9223372036854775807,
                    "aLong": "9223372036854775807",
                    "aNotherString": "a:\u00E1\u00E2\u00E4\u00E0 c:\u00E7 e:\u00E9\u00EA\u00EB\u00E8 i:\u00ED\u00EE\u00EF\u00EC\u0131 I:\u0130 o:\u00F3\u00F4\u00F6\u00F2 u:\u00FA\u00FB\u00FC\u00F9 euro:\u20AC tree:\u2F4A",
                    "aString": null //{"@xsi.nil":"true"}
                }, jsoncomplicatedRequestCallback);
            }

            // jQuery event handlers
            function xmljqueryButtonClick() {
                jQuery.ajax({
                    type: 'GET',
                    url: '../rest/helloworld',
                    dataType: 'xml'
                }).done(xmlRequestCallback);
            }
            function xmllistjqueryButtonClick() {
                jQuery.ajax({
                    type: 'GET',
                    url: '../rest/helloworld/list',
                    dataType: 'xml'
                }).done(xmllistRequestCallback);
            }

            function jsonjqueryButtonClick() {
                jQuery.ajax({
                    type: 'GET',
                    url: '../rest/helloworld',
                    dataType: 'json'
                }).done(jsonRequestCallback);
            }
            function jsonlistjqueryButtonClick() {
                jQuery.ajax({
                    type: 'GET',
                    url: '../rest/helloworld/list',
                    dataType: 'json'
                }).done(jsonlistRequestCallback);
            }
            function jsonechojqueryButtonClick() {
                jQuery.ajax({
                    type: 'POST',
                    url: '../rest/helloworld/echo',
                    dataType: 'json',
                    contentType: "application/json; charset=UTF-8",
                    data: JSON.stringify({
                        "greetings": [
                            {"who": "b"},
                            {"who": "c"}
                        ],
                        "aBigDecimal": "9999999999999999999999.1",
                        "aBigInteger": "9999999999999999999999",
                        "aBoolean": true,
                        "aDate": vanilla.dateToISO(new Date()),
                        "aDouble": 0.1,
                        "aFloat": 0.1,
                        "aGreeting": {"who": "a"},
                        "aInteger": 1,
                        //"aLong": 9007199254740992,
                        //"aLong": 9223372036854775807,
                        "aLong": "9223372036854775807",
                        "aNotherString": "a:\u00E1\u00E2\u00E4\u00E0 c:\u00E7 e:\u00E9\u00EA\u00EB\u00E8 i:\u00ED\u00EE\u00EF\u00EC\u0131 I:\u0130 o:\u00F3\u00F4\u00F6\u00F2 u:\u00FA\u00FB\u00FC\u00F9 euro:\u20AC tree:\u2F4A",
                        "aString": null //{"@xsi.nil":"true"}
                    })
                }).done(jsoncomplicatedRequestCallback);
            }

            // initialise event handlers
            function main() {
                vanilla.on('xml', 'click', xmlButtonClick);
                vanilla.on('json', 'click', jsonButtonClick);
                vanilla.on('xmllist', 'click', xmllistButtonClick);
                vanilla.on('jsonlist', 'click', jsonlistButtonClick);
                vanilla.on('xmlcomplicated', 'click', xmlcomplicatedButtonClick);
                vanilla.on('jsoncomplicated', 'click', jsoncomplicatedButtonClick);
                vanilla.on('jsonecho', 'click', jsonechoButtonClick);

                jQuery('#xmljquery').on('click', xmljqueryButtonClick);
                jQuery('#jsonjquery').on('click', jsonjqueryButtonClick);
                jQuery('#xmllistjquery').on('click', xmllistjqueryButtonClick);
                jQuery('#jsonlistjquery').on('click', jsonlistjqueryButtonClick);
                jQuery('#jsonechojquery').on('click', jsonechojqueryButtonClick);

            }

            main();
        </script>
    </body>
</html>
